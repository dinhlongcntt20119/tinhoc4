<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ôn tập HK1 - Tin học 4</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Source+Code+Pro:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root { --primary-color: #0056b3; --accent-color: #ff9800; --bg-color: #fdfbf7; --text-color: #333; --correct: #28a745; --wrong: #dc3545; }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        
        header { background: linear-gradient(135deg, var(--primary-color), #004494); color: white; padding: 20px 40px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 4px solid var(--accent-color); }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center; }
        .logo-area { font-family: 'Source Code Pro', monospace; font-size: 1.8rem; font-weight: bold; }
        .sub-title { font-size: 1rem; opacity: 0.9; margin-top: 5px; }

        .container { max-width: 900px; margin: 40px auto; padding: 0 20px; display: none; }
        
        .quiz-card { background: white; border-radius: 10px; padding: 25px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); border-left: 5px solid var(--primary-color); page-break-inside: avoid; }
        
        .q-header { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .q-icon { 
            font-size: 1.5rem; color: var(--primary-color); margin-right: 15px; 
            background: #e3f2fd; padding: 10px; border-radius: 50%; width: 45px; height: 45px; 
            display: flex; justify-content: center; align-items: center; flex-shrink: 0;
        }
        .q-title { font-weight: bold; font-size: 1.1rem; color: var(--primary-color); flex: 1; align-self: center; }

        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        .unanswered-card { border: 2px solid red !important; box-shadow: 0 0 10px rgba(255,0,0,0.2); animation: shake 0.5s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 100% { transform: translateX(0); } }

        /* Style cho đáp án */
        .option-label { display: flex; align-items: center; padding: 12px 15px; border: 1px solid #ddd; border-radius: 8px; cursor: pointer; transition: 0.2s; position: relative; background: #fff; }
        .option-label:hover { background-color: #f0f8ff; border-color: var(--primary-color); }
        .option-label input { margin-right: 15px; transform: scale(1.2); flex-shrink: 0; }
        
        /* Style riêng cho các Icon trong đáp án */
        .opt-icon { font-size: 1.4rem; margin-right: 10px; width: 30px; text-align: center; display: inline-block; color: #555; }
        .fa-bold { font-weight: bold; }
        .fa-italic { font-style: italic; }
        .fa-underline { text-decoration: underline; }

        .disabled-card { pointer-events: none; opacity: 1; }
        
        .correct-answer { background-color: #d4edda !important; border-color: var(--correct) !important; color: #155724; font-weight: bold; }
        .wrong-answer { background-color: #f8d7da !important; border-color: var(--wrong) !important; color: #721c24; opacity: 0.8; }
        
        .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -2px 10px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 20px; z-index: 100; display: none; }
        .btn { padding: 12px 30px; border-radius: 30px; border: none; font-weight: bold; cursor: pointer; font-size: 1rem; transition: 0.3s; }
        .btn-submit { background-color: var(--primary-color); color: white; }
        .btn-submit:hover { background-color: #003d82; }
        
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, var(--primary-color), #004494); display: flex; justify-content: center; align-items: center; z-index: 300; }
        .login-box { background: white; padding: 40px; border-radius: 15px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; }
        .input-group input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 1rem; }
        .btn-start { background-color: var(--accent-color); color: white; width: 100%; margin-top: 10px; }
        
        #loadingOverlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 400; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .spinner { border: 8px solid #f3f3f3; border-top: 8px solid var(--accent-color); border-radius: 50%; width: 60px; height: 60px; animation: spin 1s linear infinite; margin-bottom: 20px;}
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 200; }
        .modal-content { background: white; padding: 30px; border-radius: 15px; text-align: center; width: 400px; animation: popUp 0.3s ease; }
        .score-circle { width: 120px; height: 120px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2.5rem; font-weight: bold; margin: 20px auto; }
        
        #pdf-header { display: none; }
        @media (max-width: 600px) { .options-grid { grid-template-columns: 1fr; } .header-content { flex-direction: column; text-align: center; } .q-header {flex-direction: column; text-align: center;} .q-icon {margin-bottom: 10px; margin-right: 0;} }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <h2 style="color: var(--primary-color); margin-bottom:20px;"><i class="fas fa-user-graduate"></i> Học sinh Lớp 4</h2>
            <div class="input-group"><label>Họ và tên:</label><input type="text" id="studentName" placeholder="Nhập họ tên..."></div>
            <div class="input-group"><label>Lớp:</label><input type="text" id="studentClass" placeholder="Ví dụ: 4A"></div>
            <button class="btn btn-submit btn-start" onclick="startQuiz()">Vào làm bài</button>
        </div>
    </div>

    <div id="loadingOverlay">
        <div class="spinner"></div>
        <h3 style="color: var(--primary-color);">Đang nộp bài...</h3>
        <p>Hệ thống đang lưu file PDF lên Google Drive của thầy cô.</p>
        <p style="color: red; font-weight: bold; font-size: 0.9rem;">Vui lòng đợi 10-15 giây!</p>
    </div>

    <header id="mainHeader" style="display:none;">
        <div class="header-content">
            <div><div class="logo-area"><i class="fas fa-laptop-code"></i> TIN HỌC 4</div><div class="sub-title">Học sinh: <span id="displayInfo" style="color: var(--accent-color); font-weight: bold;"></span></div></div>
        </div>
    </header>

    <div id="pdf-area">
        <div id="pdf-header" style="text-align: center; padding: 20px; margin-bottom: 20px; border-bottom: 2px solid #333;">
            <h1 style="color: #0056b3;">KẾT QUẢ ÔN TẬP TIN HỌC 4</h1>
            <h3 id="pdf-student-info"></h3>
            <h2 id="pdf-score" style="color: red; margin: 10px 0;"></h2>
            <p><i>(Chân trời sáng tạo - Học kì 1)</i></p>
        </div>
        <main class="container" id="quiz-container"></main>
    </div>

    <div style="height: 80px;"></div> 
    <div class="footer-bar" id="footerBar"><button class="btn btn-submit" onclick="submitAndExport()"><i class="fas fa-cloud-upload-alt"></i> Nộp bài & Lưu Drive</button></div>

    <div id="resultModal" class="modal">
        <div class="modal-content">
            <h2 style="color: var(--primary-color);">Hoàn thành!</h2>
            <div class="score-circle" id="scoreDisplay">0/40</div>
            <p id="feedbackText" style="margin-bottom: 10px; font-weight: bold;">...</p>
            <div id="statusMsg" style="font-size: 0.9rem; color: #0056b3; margin-top:10px; padding: 10px; background: #e3f2fd; border-radius: 5px; font-weight: bold;"></div>
            <button class="btn btn-submit" onclick="location.reload()" style="margin-top: 15px; background-color: #6c757d;">Làm lại</button>
        </div>
    </div>

    <script>
        // --- ĐÃ ĐIỀN LINK GOOGLE SCRIPT TỪ ẢNH CỦA BẠN ---
        const GOOGLE_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzf47ydfDHEthLPpB1UXgdGNp-K6vJU4Azp5T_AVTZr-fhrWsu3h8QPDWC0bEOoWaJ9/exec";

        let info = { name: "", class: "" };
        
        // --- BỘ CÂU HỎI (ĐÃ THÊM ICON VÀO ĐÁP ÁN) ---
        const questions = [
            { 
                q: "Câu 1: Thiết bị nào sau đây là Phần cứng của máy tính?", 
                icon: "fa-hdd", 
                a: [
                    '<i class="fas fa-file-word opt-icon"></i> Phần mềm Word', 
                    '<i class="fas fa-mouse opt-icon"></i> Chuột máy tính', 
                    '<i class="fas fa-palette opt-icon"></i> Phần mềm Paint', 
                    '<i class="fab fa-windows opt-icon"></i> Hệ điều hành Windows'
                ], 
                correct: 1 
            }, 
            { 
                q: "Câu 2: Khi gõ bàn phím bằng 10 ngón, việc đặt tay lên hàng cơ sở (ASDF JKL;) giúp em điều gì?", 
                icon: "fa-keyboard", 
                a: ["Gõ nhanh, chính xác không cần nhìn phím", "Giúp máy tính khởi động nhanh hơn", "Giúp ngón tay nghỉ ngơi", "Giúp màn hình đẹp hơn"], 
                correct: 0 
            }, 
            { 
                q: "Câu 3: Tập hợp các trang thông tin trên mạng Internet, được truy cập bằng một địa chỉ chung được gọi là gì?", 
                icon: "fa-globe", 
                a: [
                    '<i class="fas fa-envelope opt-icon"></i> Email', 
                    '<i class="fas fa-globe opt-icon"></i> Website', 
                    '<i class="fas fa-file opt-icon"></i> Tệp tin', 
                    '<i class="fas fa-folder opt-icon"></i> Thư mục'
                ], 
                correct: 1 
            }, 
            { q: "Câu 4: Khi tìm kiếm thông tin trên Internet, từ khóa nên được chọn như thế nào?", icon: "fa-search", a: ["Càng dài càng tốt", "Ngắn gọn, chính xác, liên quan chủ đề", "Chung chung", "Dạng câu hỏi dài"], correct: 1 }, 
            { q: "Câu 5: Thao tác nào sẽ giúp em tạo ra một bản sao của tệp tin tại vị trí mới?", icon: "fa-copy", a: ["Sao chép (Copy) và Dán (Paste)", "Di chuyển (Cut) và Dán (Paste)", "Đổi tên (Rename)", "Xóa (Delete)"], correct: 0 }, 
            { 
                q: "Câu 6: Để quản lí các tệp tin trong máy tính, em nên tạo thành phần nào để sắp xếp chúng ngăn nắp?", 
                icon: "fa-folder-open", 
                a: [
                    '<i class="fas fa-folder opt-icon"></i> Thư mục (Folder)', 
                    '<i class="fas fa-globe opt-icon"></i> Website', 
                    '<i class="fas fa-file opt-icon"></i> Tệp tin (File)', 
                    '<i class="fas fa-link opt-icon"></i> Siêu liên kết'
                ], 
                correct: 0 
            }, 
            { q: "Câu 7: Khi em mở Thư mục A, bên trong đó thấy có Thư mục B. Vậy B được gọi là gì đối với A?", icon: "fa-folder-tree", a: ["Thư mục cha", "Thư mục con", "Tệp tin", "Website"], correct: 1 }, 
            { q: "Câu 8: Để thể hiện sự tôn trọng bản quyền khi sử dụng hình ảnh từ Internet, em nên làm gì?", icon: "fa-copyright", a: ["Tự ý sử dụng", "Ghi rõ nguồn hoặc tác giả (nếu có)", "Thay đổi màu sắc", "Nói dối là mình chụp"], correct: 1 }, 
            { 
                q: "Câu 9: Tổ hợp phím tắt nào được sử dụng để làm chữ In đậm (Bold) trong Word?", 
                icon: "fa-bold", 
                a: ["Ctrl + I", "Ctrl + B", "Ctrl + U", "Ctrl + S"], 
                correct: 1 
            }, 
            { 
                q: "Câu 10: Trong Word, muốn làm chữ In nghiêng (Italic), em sử dụng lệnh nào trong nhóm Font?", 
                icon: "fa-italic", 
                a: [
                    '<i class="fas fa-italic opt-icon"></i> Chữ I (Italic)', 
                    '<i class="fas fa-bold opt-icon"></i> Chữ B (Bold)', 
                    '<i class="fas fa-underline opt-icon"></i> Chữ U (Underline)', 
                    'Chữ S'
                ], 
                correct: 0 
            }, 
            { 
                q: "Câu 11: Trong các thành phần sau, thành phần nào của máy tính có chức năng lưu trữ dữ liệu lâu dài?", 
                icon: "fa-database", 
                a: [
                    '<i class="fas fa-desktop opt-icon"></i> Màn hình', 
                    '<i class="fas fa-mouse opt-icon"></i> Chuột', 
                    '<i class="fas fa-hdd opt-icon"></i> Ổ đĩa cứng (Hard drive)', 
                    '<i class="fas fa-keyboard opt-icon"></i> Bàn phím'
                ], 
                correct: 2 
            }, 
            { q: "Câu 12: Quy tắc cơ bản và quan trọng nhất khi đặt tay ở Hàng cơ sở là gì?", icon: "fa-hand-paper", a: ["Đặt ngón cái lên phím Enter", "Đặt hai ngón trỏ lên phím F và J", "Đặt 10 ngón lên hàng trên", "Đặt tùy ý"], correct: 1 }, 
            { q: "Câu 13: Hành động nào sau đây là SAI về mặt đạo đức khi sử dụng thông tin trên Internet?", icon: "fa-user-secret", a: ["Ghi nguồn tài liệu", "Tự ý sao chép và nhận là của mình", "Truy cập web lành mạnh", "Xin phép người lớn"], correct: 1 }, 
            { q: "Câu 14: Khi sử dụng máy tìm kiếm, chọn từ khóa thế nào là hiệu quả nhất?", icon: "fa-search-plus", a: ["Câu dài phức tạp", "Ngắn gọn, chính xác", "Rất chung chung", "Không cần từ khóa"], correct: 1 }, 
            { 
                q: "Câu 15: Muốn làm cho chữ trong Word trở nên In đậm (Bold), em cần sử dụng lệnh nào trong nhóm Font?", 
                icon: "fa-font", 
                a: [
                    '<i class="fas fa-underline opt-icon"></i> Chữ U', 
                    '<i class="fas fa-italic opt-icon"></i> Chữ I', 
                    '<i class="fas fa-bold opt-icon"></i> Chữ B', 
                    '<i class="fas fa-align-center opt-icon"></i> Căn giữa'
                ], 
                correct: 2 
            }, 
            { q: "Câu 16: Để Di chuyển (Cut và Paste) một tệp tin, kết quả cuối cùng là gì?", icon: "fa-cut", a: ["Tạo bản sao mới", "Bị xóa hoàn toàn", "Mất khỏi vị trí cũ, xuất hiện ở vị trí mới", "Được đổi tên"], correct: 2 }, 
            { q: "Câu 17: Thư mục (Folder) có chức năng chính là gì?", icon: "fa-folder", a: ["Vẽ hình", "Kết nối Internet", "Tổ chức và sắp xếp tệp tin", "In tài liệu"], correct: 2 }, 
            { q: "Câu 18: Trang web (Webpage) là gì?", icon: "fa-window-maximize", a: ["Trò chơi máy tính", "Thư điện tử", "Trang thông tin hiển thị trên trình duyệt", "Bức ảnh"], correct: 2 }, 
            { 
                q: "Câu 19: Để gạch chân (Underline) một từ trong Word, em sử dụng tổ hợp phím nào?", 
                icon: "fa-underline", 
                a: ["Ctrl + B", "Ctrl + U", "Ctrl + I", "Ctrl + Z"], 
                correct: 1 
            }, 
            { 
                q: "Câu 20: Trong hai thành phần dưới đây, thành phần nào là Phần mềm?", 
                icon: "fa-compact-disc", 
                a: [
                    '<i class="fas fa-keyboard opt-icon"></i> Bàn phím', 
                    '<i class="fas fa-mouse opt-icon"></i> Chuột', 
                    '<i class="fas fa-usb opt-icon"></i> Ổ đĩa USB', 
                    '<i class="fas fa-file-word opt-icon"></i> Phần mềm Word'
                ], 
                correct: 3 
            }, 
            { q: "Câu 21: Trong nguyên tắc gõ 10 ngón, ngón út tay phải gõ phím nào trên hàng cơ sở?", icon: "fa-hand-point-right", a: ["Phím J", "Phím F", "Phím A", "Phím ; (chấm phẩy)"], correct: 3 }, 
            { 
                q: "Câu 22: Thiết bị nào sau đây là thiết bị Đầu vào (Input)?", 
                icon: "fa-arrow-right-to-bracket", 
                a: [
                    '<i class="fas fa-print opt-icon"></i> Máy in', 
                    '<i class="fas fa-desktop opt-icon"></i> Màn hình', 
                    '<i class="fas fa-keyboard opt-icon"></i> Bàn phím', 
                    '<i class="fas fa-volume-up opt-icon"></i> Loa'
                ], 
                correct: 2 
            }, 
            { q: "Câu 23: Website là gì?", icon: "fa-network-wired", a: ["Phần mềm vẽ", "Tập hợp các trang web liên quan trên mạng", "Tệp văn bản", "Địa chỉ email"], correct: 1 }, 
            { q: "Câu 24: Để đảm bảo an toàn khi tìm kiếm thông tin, em nên làm gì?", icon: "fa-shield-alt", a: ["Chia sẻ địa chỉ nhà", "Truy cập web bất kì", "Không chia sẻ thông tin cá nhân với người lạ", "Tải phần mềm lạ"], correct: 2 }, 
            { q: "Câu 25: Để quản lí các tệp tin môn Toán, em nên tạo thành phần nào?", icon: "fa-folder-plus", a: ["Siêu liên kết", "Thư mục (Folder)", "Trang web", "Bản in"], correct: 1 }, 
            { q: "Câu 26: Muốn chữ In nghiêng (Italic) bằng phím tắt, em nhấn tổ hợp nào?", icon: "fa-italic", a: ["Ctrl + I", "Ctrl + B", "Ctrl + U", "Ctrl + S"], correct: 0 }, 
            { q: "Câu 27: Thao tác nào tạo ra bản sao nhưng vẫn giữ lại tệp gốc?", icon: "fa-clone", a: ["Di chuyển (Cut)", "Đổi tên (Rename)", "Xóa (Delete)", "Sao chép (Copy)"], correct: 3 }, 
            { q: "Câu 28: Thành phần nào sau đây là Phần cứng (Hardware)?", icon: "fa-print", a: ["Windows", "Word", "Máy in", "Paint"], correct: 2 }, 
            { q: "Câu 29: Nội dung nào đúng về bản quyền?", icon: "fa-file-signature", a: ["Không cần ghi nguồn", "Phải xin phép hoặc ghi nguồn rõ ràng", "Được bán ảnh trên mạng", "Chỉ cần ghi tên mình"], correct: 1 }, 
            { q: "Câu 30: Để tìm kiếm về 'bảo vệ môi trường', từ khóa nào hiệu quả nhất?", icon: "fa-leaf", a: ["Bảo vệ môi trường như thế nào?", "Bảo vệ môi trường", "Môi trường", "Trái đất"], correct: 1 }, 
            { q: "Câu 31: Để tạo một thư mục mới trên màn hình nền, em thực hiện thao tác nào?", icon: "fa-mouse-pointer", a: ["Nháy chuột phải -> New -> Folder", "Nháy chuột phải -> Delete", "Nháy đúp chuột", "Nhấn nút nguồn"], correct: 0 }, 
            { q: "Câu 32: Để đổi tên thư mục 'TapVe' thành 'ThucHanh_Ve', em chọn lệnh nào?", icon: "fa-edit", a: ["Copy", "Paste", "Rename", "Delete"], correct: 2 }, 
            { q: "Câu 33: Để xóa một thư mục (ví dụ 'DapAn'), em chọn lệnh nào?", icon: "fa-trash-alt", a: ["New", "Delete", "Rename", "Cut"], correct: 1 }, 
            { q: "Câu 34: Nếu muốn tạo thư mục con 'BaiTap' nằm bên trong thư mục 'Lop_4B', em phải làm gì?", icon: "fa-folder-open", a: ["Tạo ở ngoài Desktop", "Mở thư mục Lop_4B ra rồi mới tạo", "Xóa thư mục Lop_4B", "Đổi tên Lop_4B"], correct: 1 }, 
            { 
                q: "Câu 35: Lệnh Căn giữa trong Word có biểu tượng hoặc tên tiếng Anh là gì?", 
                icon: "fa-align-center", 
                a: [
                    '<i class="fas fa-align-left opt-icon"></i> Align Left', 
                    '<i class="fas fa-align-center opt-icon"></i> Center', 
                    '<i class="fas fa-align-right opt-icon"></i> Align Right', 
                    '<i class="fas fa-align-justify opt-icon"></i> Justify'
                ], 
                correct: 1 
            }, 
            { q: "Câu 36: Để thay đổi cỡ chữ lên 16, em tìm ô nào trên thanh công cụ?", icon: "fa-text-height", a: ["Font Size (Cỡ chữ)", "Font Color (Màu chữ)", "Bold (In đậm)", "Italic (In nghiêng)"], correct: 0 }, 
            { q: "Câu 37: Khi soạn thảo văn bản, để xuống dòng em nhấn phím nào?", icon: "fa-level-down-alt", a: ["Space (Cách)", "Shift", "Enter", "Caps Lock"], correct: 2 }, 
            { q: "Câu 38: Phím Backspace dùng để làm gì khi soạn thảo?", icon: "fa-backspace", a: ["Xóa kí tự bên trái con trỏ", "Xóa kí tự bên phải con trỏ", "Xuống dòng", "Viết hoa"], correct: 0 }, 
            { q: "Câu 39: Để gõ được tiếng Việt có dấu (như â, ê, ô), em cần phần mềm hỗ trợ nào?", icon: "fa-language", a: ["Unikey / Evkey", "Paint", "Zalo", "Chrome"], correct: 0 }, 
            { q: "Câu 40: Để lưu bài văn bản đang soạn thảo vào máy tính, em nhấn tổ hợp phím nào?", icon: "fa-save", a: ["Ctrl + C", "Ctrl + V", "Ctrl + S", "Ctrl + P"], correct: 2 } 
        ];

        function startQuiz() {
            const name = document.getElementById('studentName').value.trim();
            const cls = document.getElementById('studentClass').value.trim();
            if (!name || !cls) { alert("Em hãy nhập đầy đủ Họ tên và Lớp nhé!"); return; }
            info.name = name; info.class = cls;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'block';
            document.getElementById('quiz-container').style.display = 'block';
            document.getElementById('footerBar').style.display = 'flex';
            document.getElementById('displayInfo').innerText = `${name} - ${cls}`;
            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quiz-container');
            container.innerHTML = '';
            questions.forEach((q, index) => {
                let html = `
                <div class="quiz-card" id="card-${index}">
                    <div class="q-header">
                        <div class="q-icon"><i class="fas ${q.icon}"></i></div>
                        <div class="q-title">${q.q}</div>
                    </div>
                    <div class="options-grid">`;
                
                q.a.forEach((opt, i) => {
                    html += `<label class="option-label" id="opt-${index}-${i}"><input type="radio" name="q${index}" value="${i}"> ${opt}</label>`;
                });
                html += `</div></div>`;
                container.innerHTML += html;
            });
        }

        function validateFull() {
            for (let i = 0; i < questions.length; i++) {
                const checked = document.querySelector(`input[name="q${i}"]:checked`);
                if (!checked) {
                    const card = document.getElementById(`card-${i}`);
                    card.classList.add('unanswered-card');
                    card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    alert(`Em chưa làm Câu ${i+1}. Hãy hoàn thành hết trước khi nộp nhé!`);
                    setTimeout(() => card.classList.remove('unanswered-card'), 2000);
                    return false;
                }
            }
            return true;
        }

        async function submitAndExport() {
            if (!validateFull()) return;
            if(!confirm("Em có chắc chắn muốn nộp bài không?")) return;

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('footerBar').style.display = 'none';

            let score = 0;
            questions.forEach((q, index) => {
                const card = document.getElementById(`card-${index}`);
                const selected = document.querySelector(`input[name="q${index}"]:checked`);
                card.classList.add('disabled-card');
                const val = parseInt(selected.value);
                
                if (val === q.correct) {
                    score++;
                    document.getElementById(`opt-${index}-${val}`).classList.add('correct-answer');
                } else {
                    document.getElementById(`opt-${index}-${val}`).classList.add('wrong-answer');
                    document.getElementById(`opt-${index}-${q.correct}`).classList.add('correct-answer');
                }
            });

            const totalScore = `${score}/${questions.length}`;
            const pdfHeader = document.getElementById('pdf-header');
            document.getElementById('pdf-student-info').innerText = `Họ tên: ${info.name} - Lớp: ${info.class}`;
            document.getElementById('pdf-score').innerText = `Điểm số: ${totalScore}`;
            pdfHeader.style.display = 'block'; 

            const elementToPrint = document.getElementById('pdf-area');
            const fileName = `BaiThi_${info.name.replace(/\s/g,'_')}_${info.class}.pdf`;
            
            const pdfOptions = {
                margin: 5, filename: fileName, image: { type: 'jpeg', quality: 0.95 },
                html2canvas: { scale: 1.5, useCORS: true, scrollY: 0 },
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
            };

            try {
                // 1. Tạo dữ liệu PDF (Base64)
                const pdfBase64 = await html2pdf().set(pdfOptions).from(elementToPrint).output('datauristring');

                // 2. Gửi lên Google Drive
                if (GOOGLE_SCRIPT_URL.includes("DÁN_URL")) {
                    console.warn("Chưa cấu hình Google Script URL -> Chỉ tải về máy.");
                } else {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: "POST",
                        body: JSON.stringify({
                            fileName: fileName,
                            fileData: pdfBase64,
                            studentName: info.name,
                            studentClass: info.class,
                            score: totalScore
                        })
                    });
                }

                // 3. Tải về máy và Mở xem
                await html2pdf().set(pdfOptions).from(elementToPrint).toPdf().get('pdf').then(function(pdf) {
                    window.open(pdf.output('bloburl'), '_blank');
                }).save();

                document.getElementById('statusMsg').innerHTML = "<span style='color:green; font-weight:bold'><i class='fas fa-check-circle'></i> File PDF đã được lưu vào Google Drive của thầy cô.</span>";
                
            } catch (error) {
                console.error(error);
                document.getElementById('statusMsg').innerHTML = `<span style='color:red'>Lỗi kết nối Drive (Nhưng PDF đã được tải về máy).</span>`;
            } finally {
                document.getElementById('loadingOverlay').style.display = 'none';
                document.getElementById('scoreDisplay').innerText = totalScore;
                
                let msg = score >= 35 ? "Xuất sắc!" : (score >= 20 ? "Khá tốt!" : "Cố gắng hơn nhé!");
                document.getElementById('feedbackText').innerText = msg;
                document.getElementById('resultModal').style.display = 'flex';
                pdfHeader.style.display = 'none'; 
            }
        }
    </script>
</body>
</html>
