<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ôn tập Tin học 2 - Cuối kì 1</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Roboto:wght@400;500;700&family=Source+Code+Pro:wght@600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #0056b3; 
            --accent-color: #00a8ff; 
            --bg-color: #f4f7f6;
            --text-color: #333;
            --card-bg: #ffffff;
            --primary: #009688; --secondary: #ff9800; --bg: #e0f2f1; --text: #333; --correct: #c8e6c9; --wrong: #ffcdd2;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background-color: var(--bg-color); color: var(--text-color); padding-bottom: 80px; }

        /* HEADER */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--accent-color));
            color: white; padding: 15px 40px; display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-bottom: 5px solid #ffcc00; position: sticky; top: 0; z-index: 100;
        }
        .header-left h1 { font-family: 'Source Code Pro', monospace; font-size: 1.8rem; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 5px; }
        .header-left h2 { font-size: 1rem; font-weight: 400; opacity: 0.9; }
        .header-right { text-align: right; background: rgba(255, 255, 255, 0.1); padding: 10px 20px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.3); }
        .teacher-name { font-size: 1rem; font-weight: bold; color: #fff; }
        .student-info-display { color: #ffeb3b; font-weight: bold; margin-top: 5px; font-size: 1.1rem; border-top: 1px dashed rgba(255,255,255,0.3); padding-top: 5px; }

        /* LOGIN SCREEN */
        #loginScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 86, 179, 0.98); display: flex; justify-content: center; align-items: center; z-index: 2000; }
        .login-box { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        .input-group { margin-bottom: 15px; text-align: left; }
        .input-group label { font-weight: bold; display: block; margin-bottom: 5px; color: #333; }
        .input-group input, .input-group select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 10px; font-size: 1rem; outline: none; background-color: #fff; }
        .btn-start { background: var(--secondary); color: white; border: none; padding: 12px 40px; border-radius: 30px; font-size: 1.2rem; font-weight: bold; cursor: pointer; width: 100%; transition: 0.3s; }
        .btn-start:hover { transform: scale(1.05); }

        /* QUIZ CONTAINER */
        .container { max-width: 800px; margin: 40px auto; padding: 0 15px; display: none; }
        .question-card { background: white; border-radius: 15px; padding: 20px; margin-bottom: 25px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border-bottom: 5px solid #ccc; page-break-inside: avoid; }
        .q-header { display: flex; align-items: flex-start; margin-bottom: 15px; }
        .q-number { background: var(--primary-color); color: white; width: 35px; height: 35px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; margin-right: 15px; flex-shrink: 0; }
        .q-text { font-size: 1.1rem; font-weight: 600; line-height: 1.4; display: flex; align-items: center; flex-wrap: wrap; }

        .answers-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; }
        .answer-opt { display: flex; align-items: center; padding: 12px; border: 2px solid #eee; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: #fafafa; }
        .answer-opt:hover { border-color: var(--primary-color); background: #e0f2f1; }
        .answer-opt input { margin-right: 10px; transform: scale(1.3); accent-color: var(--primary-color); flex-shrink: 0; }
        .ans-text { font-weight: 500; display: flex; align-items: center; }
        .ans-img { height: 60px; width: auto; object-fit: contain; border-radius: 4px; border: 1px solid #ddd; background: white; padding: 2px; }
        .inline-img { height: 30px; width: auto; margin: 0 5px; vertical-align: middle; }

        .correct { background-color: var(--correct) !important; border-color: #4caf50 !important; color: #1b5e20; }
        .wrong { background-color: var(--wrong) !important; border-color: #f44336 !important; color: #b71c1c; opacity: 0.8; }
        .unanswered { border: 2px solid red; animation: shake 0.4s; }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } }

        /* PDF AREA STYLE */
        #pdf-area { background: white; padding: 20px; } 
        #pdf-header-info { display: none; text-align: center; margin-bottom: 20px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        #pdf-header-info h1 { color: var(--primary-color); margin: 0 0 10px 0; }
        #pdf-header-info p { font-size: 1.2rem; margin: 5px 0; font-weight: bold; }

        /* FOOTER & OVERLAY */
        .footer-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: white; padding: 15px; box-shadow: 0 -5px 20px rgba(0,0,0,0.1); display: flex; justify-content: center; gap: 20px; z-index: 1000; display: none; }
        .btn-submit { background: var(--primary-color); color: white; border: none; padding: 12px 30px; border-radius: 30px; font-weight: bold; font-size: 1.1rem; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: 0.3s; }
        .btn-submit:hover { background: #004494; transform: translateY(-3px); }
        
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); display: none; justify-content: center; align-items: center; z-index: 3000; flex-direction: column; color: white; }
        .spinner { border: 6px solid #f3f3f3; border-top: 6px solid var(--secondary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .result-box { background: white; color: #333; padding: 30px; border-radius: 20px; text-align: center; width: 90%; max-width: 400px; animation: popUp 0.3s ease; }
        .score-circle { width: 100px; height: 100px; background: var(--primary-color); color: white; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-size: 2rem; font-weight: bold; margin: 20px auto; }
        
        footer { text-align: center; padding: 20px; margin-top: 50px; color: #777; font-size: 0.9rem; border-top: 1px solid #ddd; background-color: white; }
        @media (max-width: 768px) { header { flex-direction: column; text-align: center; gap: 15px; } .header-right { text-align: center; width: 100%; } }
    </style>
</head>
<body>

    <div id="loginScreen">
        <div class="login-box">
            <i class="fas fa-desktop" style="font-size: 3rem; color: var(--primary-color); margin-bottom: 15px;"></i>
            <h2 style="color: var(--primary-color); margin-bottom: 20px;">ÔN TẬP TIN HỌC 2</h2>
            <div class="input-group">
                <label>Họ và tên:</label>
                <input type="text" id="sName" placeholder="Nhập tên...">
            </div>
            <div class="input-group">
                <label>Lớp:</label>
                <select id="sClass">
                    <option value="">-- Chọn lớp --</option>
                    <option value="2A">2A</option>
                    <option value="2D">2D</option>
                </select>
            </div>
            <button class="btn-start" onclick="startQuiz()">BẮT ĐẦU</button>
        </div>
    </div>

    <header id="mainHeader" style="display: none;">
        <div class="header-left">
            <h1><i class="fas fa-laptop-code"></i> TIN HỌC 2</h1>
            <h2>Bộ sách: Luyện tập Tin học</h2>
        </div>
        <div class="header-right">
            <div class="teacher-name">GV - Nguyễn Đình Bạch Long</div>
            <div class="student-info-display" id="displayInfo"></div>
        </div>
    </header>

    <div style="text-align: center; margin-top: 20px; display: none;" id="backButtonArea">
        <a href="../index.html" style="text-decoration: none; color: #666;"><i class="fas fa-arrow-left"></i> Quay lại trang chủ</a>
    </div>

    <div id="pdf-area">
        <div id="pdf-header-info">
            <h1>KẾT QUẢ ÔN TẬP CUỐI KÌ 1</h1>
            <p id="pdf-name"></p>
            <p id="pdf-score" style="color: red; font-size: 1.5rem;"></p>
        </div>
        <div class="container" id="quizContainer"></div>
    </div>

    <footer id="mainFooter" style="display: none;">
        &copy; 2025 - Website hỗ trợ học tập Tin học 2 | GV Nguyễn Đình Bạch Long
        <div>Email: dinhlongcntt20119@gmail.com  |  SĐT: 0937438939</div>
        <div>STK: 0937438939  |  Ngân hàng: Vietinbank</div>
    </footer>

    <div class="footer-bar" id="footerBar">
        <button class="btn-submit" onclick="submitExam()"><i class="fas fa-cloud-upload-alt"></i> Nộp bài & Lưu Drive</button>
    </div>

    <div id="loadingOverlay" class="overlay">
        <div class="spinner"></div>
        <h3>Đang xử lý...</h3>
        <p>Đang gửi bài lên hệ thống...</p>
    </div>

    <div id="resultModal" class="overlay">
        <div class="result-box">
            <h2 style="color: var(--primary-color);">Hoàn thành!</h2>
            <div class="score-circle" id="scoreDisplay">0/0</div>
            <p id="msg" style="font-weight: bold; margin-bottom: 10px;"></p>
            <div id="driveMsg" style="background: #e8f5e9; color: #1b5e20; padding: 10px; border-radius: 8px; font-size: 0.9rem;">
                </div>
            <button class="btn-start" style="margin-top: 15px; background: #757575;" onclick="location.reload()">Làm lại</button>
            <a href="../index.html" class="btn-start" style="margin-top: 10px; background: var(--primary-color); display: inline-block; text-decoration: none; padding: 12px 0;">Về trang chủ</a>
        </div>
    </div>

    <script>
        // LINK SCRIPT MỚI CỦA BẠN
        const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_Gqu3lHj0iNQG_btpRZFHSJDLcsqy01Bk19wrWKIPvzCHlVxA8orqa1jZTzXFFmfxZg/exec";
        
        let student = { name: "", class: "" };

        // --- DỮ LIỆU CÂU HỎI ---
        let questions = [
            // CÂU 1
            { 
                q: "Em hãy chỉ ra biểu tượng của phần mềm Paint (Vẽ)?", 
                a: [
                    {t: "<img src='circus.png' class='ans-img'>"}, 
                    {t: "<img src='paint.jpg' class='ans-img'>"}, 
                    {t: "<img src='calculator.png' class='ans-img'>"}
                ], 
                c: 1 
            },
            // CÂU 2
            { 
                q: "Công cụ Text <img src='text.png' class='inline-img'> trong Paint giúp em làm gì?", 
                a: [
                    {t: "Vẽ đường cong"}, 
                    {t: "Tô màu hình vẽ"}, 
                    {t: "Gõ chữ vào khung vẽ"}
                ], 
                c: 2 
            },
            { 
                q: "Để vẽ được hình vuông hoặc hình tròn chuẩn xác, em cần nhấn giữ phím nào?", 
                a: [
                    {t: "Phím Shift"}, 
                    {t: "Phím Ctrl"}, 
                    {t: "Phím Alt"}
                ], 
                c: 0 
            },
            { 
                q: "Để sao chép một mẫu vẽ đã chọn trong Paint, em thực hiện thao tác nào?", 
                a: [
                    {t: "Giữ phím Shift + Kéo chuột"}, 
                    {t: "Giữ phím Ctrl + Kéo chuột"}, 
                    {t: "Giữ phím Alt + Kéo chuột"}
                ], 
                c: 1 
            },
            // CÂU 5
            { 
                q: "Để đóng tiện ích đồng hồ (Clock) đang mở trên màn hình Desktop, em nhấp chuột vào biểu tượng nào?", 
                a: [
                    {t: "<img src='tick.png' class='ans-img'>"}, 
                    {t: "<img src='setting.png' class='ans-img'>"}, 
                    {t: "<img src='close.png' class='ans-img'>"}
                ], 
                c: 2 
            },
            // BỔ SUNG
            { 
                q: "Trong trò chơi 'Circus 1', để bắt đầu trò chơi mới em chọn lệnh nào?", 
                a: [{t: "Play Game"}, {t: "Start new circus"}, {t: "Next Puzzle"}], 
                c: 1 
            },
            { 
                q: "Công cụ 'Kính lúp' (Magnifier) dùng chuột trái để làm gì?", 
                a: [{t: "Phóng to hình"}, {t: "Thu nhỏ hình"}, {t: "Thoát"}], 
                c: 0 
            },
            { 
                q: "Công cụ 'Thùng sơn' (Fill with color) dùng để làm gì?", 
                a: [{t: "Chọn màu vẽ"}, {t: "Tô màu vùng khép kín"}, {t: "Tẩy xóa"}], 
                c: 1 
            },
            { 
                q: "Công cụ Oval dùng để vẽ hình gì?", 
                a: [{t: "Hình chữ nhật"}, {t: "Hình tròn / Bầu dục"}, {t: "Hình tam giác"}], 
                c: 1 
            },
            { 
                q: "Trong công cụ Text, nút chữ B dùng để làm gì?", 
                a: [{t: "Chữ nghiêng"}, {t: "Chữ đậm"}, {t: "Gạch chân"}], 
                c: 1 
            },
            { 
                q: "Trong công cụ Text, nút chữ I dùng để làm gì?", 
                a: [{t: "Gạch chân"}, {t: "Chữ đậm"}, {t: "Chữ nghiêng"}], 
                c: 2 
            },
            { 
                q: "Trong công cụ Text, nút chữ U dùng để làm gì?", 
                a: [{t: "Chữ đậm"}, {t: "Chữ nghiêng"}, {t: "Gạch chân"}], 
                c: 2 
            },
            { 
                q: "Công cụ Đường cong (Curve) cần mấy lần nhấp chuột để hoàn thành một nét vẽ?", 
                a: [{t: "1 lần"}, {t: "2 lần"}, {t: "3 lần"}], 
                c: 2 
            },
            { 
                q: "Để vẽ Cờ Tổ quốc, em dùng công cụ nào để vẽ ngôi sao?", 
                a: [{t: "Ngôi sao 5 cánh"}, {t: "Hình tròn"}, {t: "Hình vuông"}], 
                c: 0 
            },
            { 
                q: "Để lật hình nằm ngang (như soi gương), em chọn lệnh nào?", 
                a: [{t: "Xoay phải 90 độ"}, {t: "Lật dọc"}, {t: "Lật ngang (Flip horizontal)"}], 
                c: 2 
            },
            { 
                q: "Để hình không bị che khuất khi di chuyển, em chọn chế độ nào?", 
                a: [{t: "Chọn bình thường"}, {t: "Chọn trong suốt (Transparent)"}, {t: "Chọn tự do"}], 
                c: 1 
            },
            { 
                q: "Công cụ chọn hình chữ nhật tên là gì?", 
                a: [{t: "Rectangular selection"}, {t: "Free-form selection"}, {t: "Select all"}], 
                c: 0 
            },
            { 
                q: "Để tắt máy tính đúng cách, em chọn lệnh nào?", 
                a: [{t: "Sleep"}, {t: "Restart"}, {t: "Shut down"}], 
                c: 2 
            },
            { 
                q: "Để vẽ thân cây trong bài tập vẽ cây ăn quả, em nên sử dụng công cụ nào?", 
                a: [{t: "Công cụ Oval"}, {t: "Công cụ Polygon (Đa giác)"}, {t: "Công cụ Line (Đường thẳng)"}], 
                c: 1 
            },
            { 
                q: "Trong hoạt động vẽ 4 chiếc lá, sau khi vẽ đường cong nằm nghiêng, em cần thực hiện thao tác gì tiếp theo?", 
                a: [{t: "Vẽ gân lá"}, {t: "Sao chép và xoay 180°"}, {t: "Tô màu"}], 
                c: 1 
            }
        ];

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }

        function startQuiz() {
            const name = document.getElementById('sName').value.trim();
            const cls = document.getElementById('sClass').value;
            
            if(!name) { alert("Con nhớ điền tên nhé!"); return; }
            if(!cls) { alert("Con nhớ chọn lớp nhé!"); return; }
            
            student.name = name; student.class = cls;
            document.getElementById('displayInfo').innerText = `${name} - Lớp ${cls}`;
            document.getElementById('loginScreen').style.display = 'none';
            document.getElementById('mainHeader').style.display = 'flex'; 
            document.getElementById('mainFooter').style.display = 'block';
            document.getElementById('backButtonArea').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('footerBar').style.display = 'flex';
            
            shuffleArray(questions);
            renderQuiz();
        }

        function renderQuiz() {
            const container = document.getElementById('quizContainer');
            container.innerHTML = "";
            questions.forEach((q, idx) => {
                let html = `
                <div class="question-card" id="card-${idx}">
                    <div class="q-header">
                        <div class="q-number">${idx + 1}</div>
                        <div class="q-text">${q.q}</div>
                    </div>
                    <div class="answers-grid">
                        ${q.a.map((opt, optIdx) => `
                            <label class="answer-opt" id="lbl-${idx}-${optIdx}">
                                <input type="radio" name="q${idx}" value="${optIdx}">
                                <span class="ans-text">${opt.t}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>`;
                container.innerHTML += html;
            });
        }

        async function submitExam() {
            let unanswered = [];
            questions.forEach((_, idx) => {
                const checked = document.querySelector(`input[name="q${idx}"]:checked`);
                const card = document.getElementById(`card-${idx}`);
                card.classList.remove('unanswered');
                if(!checked) { unanswered.push(idx); card.classList.add('unanswered'); }
            });

            if(unanswered.length > 0) {
                alert(`Con ơi, còn ${unanswered.length} câu chưa làm xong. Con kiểm tra các khung màu đỏ nhé!`);
                document.getElementById(`card-${unanswered[0]}`).scrollIntoView({behavior: "smooth", block: "center"});
                return;
            }

            if(!confirm("Con đã chắc chắn nộp bài chưa?")) return;

            let score = 0;
            questions.forEach((q, idx) => {
                const checked = document.querySelector(`input[name="q${idx}"]:checked`);
                const val = parseInt(checked.value);
                document.querySelectorAll(`input[name="q${idx}"]`).forEach(inp => inp.disabled = true);
                if(val === q.c) {
                    score++;
                    document.getElementById(`lbl-${idx}-${val}`).classList.add('correct');
                } else {
                    document.getElementById(`lbl-${idx}-${val}`).classList.add('wrong');
                    document.getElementById(`lbl-${idx}-${q.c}`).classList.add('correct');
                }
            });

            document.getElementById('loadingOverlay').style.display = 'flex';
            document.getElementById('footerBar').style.display = 'none';
            
            const scoreText = `${score}/${questions.length}`;
            const pdfHeader = document.getElementById('pdf-header-info');
            pdfHeader.style.display = 'block';
            document.getElementById('pdf-name').innerText = `Họ tên: ${student.name} - Lớp: ${student.class}`;
            document.getElementById('pdf-score').innerText = `Điểm số: ${scoreText}`;

            const element = document.getElementById('pdf-area');
            const fileName = `BaiThi_${student.class}_${student.name}.pdf`;
            const opt = { 
                margin: 5, 
                filename: fileName, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 1.5, useCORS: true, scrollY: 0 }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
            };

            let driveStatus = "";

            try {
                // 1. TẠO PDF DẠNG BASE64 ĐỂ GỬI ĐI
                const pdfData = await html2pdf().set(opt).from(element).outputPdf('datauristring');
                const base64Content = pdfData.split(',')[1];

                // 2. GỬI LÊN GOOGLE SCRIPT (Dùng text/plain để tránh lỗi CORS)
                // Lưu ý: await fetch sẽ không trả về response đọc được do mode 'no-cors'
                // Nhưng nó vẫn gửi dữ liệu đi thành công.
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'text/plain' },
                    body: JSON.stringify({
                        fileName: fileName,
                        fileData: base64Content
                    })
                });
                
                driveStatus = "<span style='color:green'>✔ Đã lưu bài lên hệ thống giáo viên.</span>";

                // 3. TẢI FILE VỀ MÁY HỌC SINH LUÔN
                await html2pdf().set(opt).from(element).save();

            } catch (err) {
                console.error(err);
                // Nếu lỗi gửi mạng, vẫn cố tải file về máy
                await html2pdf().set(opt).from(element).save();
                driveStatus = "<span style='color:orange'>⚠ Lỗi kết nối mạng, bài đã tải về máy con.</span>";
            }

            document.getElementById('loadingOverlay').style.display = 'none';
            pdfHeader.style.display = 'none';
            document.getElementById('scoreDisplay').innerText = scoreText;
            document.getElementById('msg').innerText = score >= 15 ? "Con làm bài rất xuất sắc!" : "Con làm tốt lắm, cố gắng thêm nhé!";
            document.getElementById('driveMsg').innerHTML = driveStatus;
            document.getElementById('resultModal').style.display = 'flex';
        }
    </script>
</body>
</html>