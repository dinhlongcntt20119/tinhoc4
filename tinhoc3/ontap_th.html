/* --- HÀM LƯU DRIVE & PDF (GỌI GAS) --- */
    function saveToDrive() {
        // Bắt buộc hoàn thành mới được nộp
        if(!checkCompletion()) return;

        // Chấm điểm để hiện kết quả trong file lưu
        const result = chamDiem(true);
        
        const btn = document.getElementById('btn-drive');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Đang xử lý...';
        btn.disabled = true;

        const name = document.getElementById('student-name').value;
        const className = document.getElementById('student-class').value;
        // Lấy toàn bộ nội dung HTML của trang bài tập (bao gồm kết quả đã chấm)
        const content = document.querySelector('.page').innerHTML;
        const styles = document.querySelector('style').innerHTML;

        // Tạo form data gửi lên GAS
        const formData = new FormData();
        const fullHtml = `
            <!DOCTYPE html>
            <html>
            <head>
                <style>${styles}</style>
            </head>
            <body>
                <div class="page" style="margin:0 auto;">
                    <h2>Học sinh: ${name} - Lớp: ${className}</h2>
                    <h3>Kết quả: ${result.score}/${result.total}</h3>
                    <hr>
                    ${content}
                </div>
            </body>
            </html>
        `;
        
        formData.append('html', fullHtml);
        formData.append('filename', `${name}_${className}_TinHoc3_${Date.now()}`);

        // Gửi POST request tới đường dẫn Google Script mới của bạn
        fetch("https://script.google.com/macros/s/AKfycbyzQaM_mGvgWtBwT-c7YM3g_g-PNZR_g5sRL4Z69rL4Cupgm10Udz-xXLPWW6ugOEU/exec", {
            method: "POST",
            body: formData,
            mode: 'no-cors' 
        })
        .then(() => {
            alert("Đã gửi bài thành công! File PDF đang được tạo trên Google Drive của giáo viên.");
            btn.innerHTML = '<i class="fas fa-check"></i> Đã Nộp Xong';
        })
        .catch(err => {
            alert("Có lỗi khi gửi bài: " + err);
            btn.innerHTML = originalText;
            btn.disabled = false;
        });
    }